---
#Install Kube dashboarwd
- name: Deploy kubernetes dashboard into cluster
  command: |
          kubectl --kubeconfig={{ KUBE_CONF }} \
          create -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
  retries: 5
  delay: 2
  ignore_errors: true
  register: dashboard_ready

- name: Creating kube-config dirs
  file:
          path: "{{ KUBE_CONF_DIR }}"
          state: directory

- name: Copy kubenetes dashboard user configs
  copy: 
          src: files/dashboard-admin-user.yml
          dest: "{{ KUBE_CONF_DIR }}/dashboard-admin-user.yml"
          owner: root
          group: "{{ KUBE_USER_GROUP }}"
          mode: 0775
- name: Copy dashboard user RBAC bindings 
  copy: 
          src: files/dashboard-admin-binding.yml
          dest: "{{ KUBE_CONF_DIR }}/dashboard-admin-binding.yml"
          owner: root
          group: "{{ KUBE_USER_GROUP }}"
          mode: 0775
 
- name: Create Dashboard admin role 
  command: |
          kubectl --kubeconfig={{ KUBE_CONF }} \
          apply -f {{ KUBE_CONF_DIR }}/dashboard-admin-user.yml
  when: dashboard_ready
  register: dashboard_user_ready
          #k8s:
          #state: present
          #src: files/dashboard-admin-binding.yml
          
- name: Create Dashboard admin role binding
  command: |
          kubectl --kubeconfig={{ KUBE_CONF }} \
          apply -f {{ KUBE_CONF_DIR }}/dashboard-admin-binding.yml
  when: dashboard_ready
